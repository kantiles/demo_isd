---
title: "Birth indicators in France"
format: 
  dashboard:
    logo: person-arms-up
    orientation: rows
    nav-buttons:
        - icon: github
          href: https://github.com/kantiles/demo_isd
---

```{ojs}
//| output: false

// load data
data = FileAttachment("data/isd_assemble_ojs.csv").csv({delimiter: ";", typed: true})

data_grid = FileAttachment("data/grid_dep_ojs.csv").csv({delimiter: ";", typed: true})
```

# Dep

## {.sidebar}

```{ojs}
//| output: false

depFrance = FileAttachment("data/raw.topojson").json()
depContours = topojson.feature(depFrance, "France")

projection = d3.geoMercator().center([2, 47])                // GPS of location to zoom on
    .scale(800)                       // This is like the zoom
    .translate([ 220/2, 220/2 ])
pathGenerator = d3.geoPath(projection)

frMap = value => {
  const svg = d3.create('svg')
      .attr('width', 220)
      .attr('height', 220);

  const statesDrawn = svg.selectAll(".state")
    .data(depContours.features)
    .join("path")
      .attr("class", "state")
      .attr("d", pathGenerator)
      .attr("fill", "white")
      .attr("stroke", "grey")
      // sending updates:
      // when a state is clicked, set the value property and emit an input event
      .on('click', (event, d) => svg.property('value', d.properties.INSEE_DEP).dispatch('input'));

  // receiving updates:
  // update the map in the setter
  Object.defineProperty(svg.node(), "value", {
    get() {
      return value;
    },
    set(v) {
      value = v;
      statesDrawn
          .attr("fill", d => d.properties.INSEE_DEP === v ? "blue" : "white")
          .attr("opacity", d => d.properties.INSEE_DEP === v ? 0.5 : 1.0);
    }
  });

  // initial value
  svg.property('value', value);
  
  return svg.node();
}
```

```{ojs}
Inputs.bind(
  Inputs.select(
    new Map(depContours.features.map(d => [d.properties.LIBELLE_DEPARTEMENT, d.properties.INSEE_DEP])), 
  {sort: true, label: "Select an area: ", format: ([name, value]) => `${name}`}), 
  viewof dep
  )
```

```{ojs}
viewof dep = frMap('2A')
```



```{ojs}
//| output: false


// filter data
filtered = data.filter(function(x) {
  return dep == x.code_geo ;
})

// filter for each graph
// to do - function to wrap that
filtered_c22 = filtered.filter(function(x) {
  return x.isd == "C22"})

filtered_c23 = filtered.filter(function(x) {
  return x.isd == "C23"})

filtered_c24 = filtered.filter(function(x) {
  return x.isd == "C24"})

// last year
data_last = data.filter(function(x) {
  return x.annee == 2022})

filtered_last = data_last.filter(function(x) {
  return dep == x.code_geo})
```

## Column

### Row {height=15%}
```{r}
#| content: valuebox
#| title: nombre de naissances

cat(54)
```

```{r}
#| content: valuebox
#| title: faibles poids
#| color : red

cat(54)
```
```{r}
#| content: valuebox
#| title: prema
#| color : blue
#| icon: pencil

cat(54)
```

### Row

```{ojs}
//| title: last year

// todo : function

// barcode with value
Plot.plot({
    marks : [
        Plot.tickX(data_last.filter(function(x) {
  return x.isd == "C24"}), {x: "value", y: "indicator", stroke:"lightgrey"}),
        Plot.tickX(filtered_last.filter(function(x) {
  return x.isd == "C24"}), {x: "value", y: "indicator", stroke:"red"})
    ]
    })
```

### Row

```{ojs}
//| title: c24 - par age
Plot.plot({
    x:{domain: [2012, 2022]},
    marks : [
        Plot.areaY(filtered_c24, {x: "annee", y: "value", fill:"indicator"})
    ]
    })

```

# Indicators

## {.toolbar}

```{ojs}
//| output: false
isd_names = [
  {isd : "C22", isd_name : "Baby age"},
  {isd : "C23", isd_name : "Weight"},
  {isd : "C24", isd_name : "Mother age"}
]

indicator_names = [
  {isd : "C22", indicator : "tx_tr_gde_prema_av28sa", indicator_name: "28 weeks"},
  {isd : "C22", indicator : "tx_gde_prema_av32sa", indicator_name: "32 weeks"},
  {isd : "C22", indicator : "tx_prema_av37sa", indicator_name: "37 weeks"},
  {isd : "C23", indicator : "part_nais_moins_1500g", indicator_name: "1500g"},
  {isd : "C23", indicator : "part_nais_moins_2500g", indicator_name: "2500g"},
  {isd : "C24", indicator : "part_accouch_m20", indicator_name: "less than 20"},
  {isd : "C24", indicator : "part_accouch_20_24", indicator_name: "20-24"},
  {isd : "C24", indicator : "part_accouch_25_29", indicator_name: "25-29"},
  {isd : "C24", indicator : "part_accouch_30_34", indicator_name: "30-34"},
  {isd : "C24", indicator : "part_accouch_35_39", indicator_name: "35-39"},
  {isd : "C24", indicator : "part_accouch_40p", indicator_name: "40 and more"},
]
```

```{ojs}
// mettre des defaults
viewof isd = Inputs.radio(
   new Map(isd_names.map(d => [d.isd_name, d.isd])), {format: ([name, value]) => `${name}`, sort: true, unique: true, value: "C24", label: "Indicator: "}
)
```

```{ojs}
viewof indicator = Inputs.radio(
   new Map(indicator_names.filter((x)=>{return x.isd == isd}).map(d =>[d.indicator_name, d.indicator])), {sort: true, unique: true, value: "part_accouch_m20", label: "Dimension: "}
)
```

```{ojs}
//| output: false
data_grid_filtered = data_grid.filter(function(x){
        return x.isd == isd && x.indicator == indicator
      })

```



## Row

### Column

```{ojs}
//| title: carte

// indicateur global sur un graph
Plot.plot({
  height: 600,
  axis: null,
  color: {
    type: "linear",
    scheme: "piyg"
  },
  marks: [
    Plot.cell(data_grid_filtered, {x: "col", y: "row", fill: "value", inset: 0.5, tip: true}),
    Plot.text(data_grid_filtered, {x: "col", y: "row",  text: "code", fill: "black", dy: -5}),
    Plot.text(data_grid_filtered, {x: "col", y: "row",  text: "value", fill: "black", dy: 7, fillOpacity: 0.6})
  ]
})
```

### Column

```{ojs}
//| title: c24 - par age

// indicateur global sur un graph
Plot.plot({
    x: {axis: "top", grid: true, domain:[0, 100]},
    color: {scheme: "spectral", legend: true},
    marks: [
      Plot.ruleX([0]),
      Plot.barX(data_last.filter(function(x){
        return x.isd == "C24"
      }), {x: "value", y: "code_geo", fill: "indicator", title: "indicator", tip: true, sort: {color: null}}), // color in input order
      Plot.text(data_last.filter(function(x){
        return x.isd == "C24"
      }), Plot.selectMinX({x: "value", y: "code_geo", textAnchor: "end", dx: -6, text: "code_geo"}))
    ]
  });
```

# Docs

// faire un sub fichier pour voir si c'est possible

This dashboard is an exploration around some context indicators about births in France. It aims at showing some capabilities of [Observable JS](https://observablehq.com/) and [Quarto Dashboard](https://quarto.org/docs/dashboards/interactivity/observable.html) to display data in a reactive context. Data cleaning and wrangling was done in R by Kantiles. Code is available on [Github](https://github.com/kantiles/demo_isd).

Data comes from [France's Ministry of Health](https://data.drees.solidarites-sante.gouv.fr/explore/dataset/1520_indicateurs-de-sante-perinatale/information/).

> This vizualisation hasn't been approved by the Ministry of Health and should only be use as a demonstrator. Please see the official dashboard on [VILAS](https://odin-dataviz-drees.sante.gouv.fr/digdash_dashboard_dataviz_drees/?defaultPage=vilas_Accueil&user=dataviz_sante&pass=dataviz_sante).
